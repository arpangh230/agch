<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ফ্যাশনফ্লো প্রো</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-purple: #6a0dad;
            --light-purple: #8a2be2;
            --dark-purple: #4b0082;
            --text-dark: #333;
            --text-light: #f8f8f8;
            --bg-light: #f4f4f4;
            --card-bg: #fff;
            --border-color: #ddd;
            --shadow-light: rgba(0,0,0,0.08);
            --shadow-medium: rgba(0,0,0,0.15);
        }

        body {
            font-family: 'Noto Sans Bengali', 'Poppins', Arial, sans-serif;
            margin: 0;
            background-color: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
        }

        #login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 5px 15px var(--shadow-medium);
            text-align: center;
        }

        #login-form h2 {
            color: var(--primary-purple);
            margin-bottom: 25px;
            font-size: 28px;
        }

        #login-form input[type="text"],
        #login-form input[type="password"] {
            width: calc(100% - 20px);
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 16px;
        }

        #login-form button {
            background-color: var(--primary-purple);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            width: 100%;
            transition: background-color 0.3s ease;
        }

        #login-form button:hover {
            background-color: var(--dark-purple);
        }

        .error-message {
            color: #dc3545;
            margin-top: 15px;
            font-size: 14px;
        }

        /* App Layout */
        #app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Navigation */
        #sidebar {
            width: 250px;
            background-color: var(--primary-purple);
            color: var(--text-light);
            padding: 20px 0;
            box-shadow: 2px 0 10px var(--shadow-light);
            display: flex;
            flex-direction: column;
            position: sticky;
            top: 0;
            height: 100vh;
        }

        #sidebar .app-logo {
            text-align: center;
            margin-bottom: 30px;
        }

        #sidebar .app-logo img {
            width: 60px;
            height: 60px;
            margin-bottom: 10px;
        }

        #sidebar .app-logo h1 {
            margin: 0;
            font-size: 24px;
            color: white;
            font-weight: 700;
        }

        #sidebar nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
            flex-grow: 1;
        }

        #sidebar nav ul li {
            margin-bottom: 5px;
        }

        #sidebar nav ul li a {
            display: flex;
            align-items: center;
            color: var(--text-light);
            text-decoration: none;
            padding: 12px 20px;
            transition: background-color 0.3s ease, color 0.3s ease;
            font-size: 16px;
        }

        #sidebar nav ul li a i {
            margin-right: 15px;
            font-size: 18px;
        }

        #sidebar nav ul li a:hover,
        #sidebar nav ul li a.active {
            background-color: var(--dark-purple);
            color: white;
            border-left: 5px solid white;
            padding-left: 15px;
        }

        #sidebar .logout-section {
            margin-top: auto;
            padding: 20px;
            text-align: center;
        }

        #sidebar .logout-section button {
            background-color: #dc3545;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: background-color 0.3s ease;
        }

        #sidebar .logout-section button:hover {
            background-color: #c82333;
        }


        /* Main Content Area */
        #main-content {
            flex-grow: 1;
            padding: 30px;
            background-color: var(--bg-light);
        }

        /* Top Bar / Header */
        #topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--bg-light);
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
            margin-bottom: 20px;
        }

        #topbar h2 {
            margin: 0;
            font-size: 28px;
            color: var(--primary-purple);
            font-weight: 600;
        }

        .user-profile {
            display: flex;
            align-items: center;
        }

        .user-profile .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background-color: #e0e0e0;
            margin-left: 15px;
            overflow: hidden;
            border: 2px solid var(--primary-purple);
            cursor: pointer;
        }
        .user-profile .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-profile .user-info {
            text-align: right;
            font-size: 16px;
        }
        .user-profile .user-info p {
            margin: 0;
            color: var(--text-dark);
            font-weight: 500;
        }
        .user-profile .user-info span {
            font-size: 14px;
            color: #666;
        }

        /* Section Styling */
        .app-section {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 3px 10px var(--shadow-light);
            margin-bottom: 30px;
            display: none; /* Hidden by default */
        }
        .app-section.active {
            display: block; /* Active section is shown */
        }

        .app-section h2 {
            color: var(--primary-purple);
            font-size: 24px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
        }
        .app-section h2 i {
            margin-right: 10px;
            color: #8a2be2;
        }

        /* Dashboard Specific */
        .dashboard-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, var(--primary-purple), var(--light-purple));
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .summary-card:hover {
            transform: translateY(-5px);
        }
        .summary-card i {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 35px;
            opacity: 0.2;
            color: white;
        }
        .summary-card h3 {
            margin-top: 0;
            font-size: 16px;
            font-weight: 500;
            opacity: 0.8;
        }
        .summary-card p {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0 0;
        }

        .recent-activities, .quick-actions {
            margin-top: 30px;
        }
        .recent-activities h3, .quick-actions h3 {
            font-size: 20px;
            color: var(--primary-purple);
            margin-bottom: 15px;
        }
        .activity-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px dashed #eee;
            font-size: 15px;
        }
        .activity-item:last-child {
            border-bottom: none;
        }
        .activity-item span:first-child {
            font-weight: 500;
        }
        .activity-item span:last-child {
            color: #777;
        }

        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }
        .quick-action-card {
            background: #f0f8ff;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s ease, background-color 0.2s ease;
        }
        .quick-action-card:hover {
            transform: translateY(-3px);
            background-color: #e0f2ff;
        }
        .quick-action-card i {
            font-size: 35px;
            color: var(--primary-purple);
            margin-bottom: 10px;
        }
        .quick-action-card h4 {
            margin: 0;
            font-size: 16px;
            color: var(--text-dark);
            font-weight: 500;
        }


        /* Forms and Inputs (General) */
        form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 15px;
        }

        form input[type="text"],
        form input[type="number"],
        form input[type="password"],
        form input[type="date"],
        form select,
        form textarea {
            width: calc(100% - 24px); /* Account for padding and border */
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box; /* Include padding/border in width */
            background-color: #fcfcfc;
        }
        form input[type="number"] {
            -moz-appearance: textfield; /* Remove default number input arrows in Firefox */
        }
        form input[type="number"]::-webkit-outer-spin-button,
        form input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        form button, .action-buttons button {
            background-color: #28a745; /* Green for add/save */
            color: white;
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            margin-right: 10px;
            transition: background-color 0.3s ease, transform 0.2s ease;
            white-space: nowrap; /* Prevent button text from wrapping */
        }
        form button:hover, .action-buttons button:hover {
            background-color: #218838;
            transform: translateY(-1px);
        }

        .cancel-btn {
            background-color: #6c757d !important; /* Grey for cancel */
        }
        .cancel-btn:hover {
            background-color: #5a6268 !important;
        }

        .danger-btn {
            background-color: #dc3545 !important; /* Red for delete */
        }
        .danger-btn:hover {
            background-color: #c82333 !important;
        }
        .edit-btn {
            background-color: #ffc107 !important; /* Yellow for edit */
            color: #333 !important;
        }
        .edit-btn:hover {
            background-color: #e0a800 !important;
        }

        .primary-btn { /* Use for main actions like add, save */
            background-color: var(--primary-purple) !important;
        }
        .primary-btn:hover {
            background-color: var(--dark-purple) !important;
        }


        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: var(--card-bg);
            border-radius: 8px;
            overflow: hidden; /* To apply border-radius to table */
        }

        table thead {
            background-color: #f0f0f0;
            color: var(--text-dark);
            font-weight: 600;
        }

        table th, table td {
            border: 1px solid #eee;
            padding: 12px;
            text-align: left;
            font-size: 15px;
        }
        table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        table tbody tr:hover {
            background-color: #f0f8ff;
        }
        .table-action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        .table-action-buttons button {
            padding: 6px 10px;
            font-size: 13px;
        }

        /* Product Grid */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .product-card {
            background: var(--card-bg);
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 8px var(--shadow-light);
            transition: transform 0.2s ease;
        }
        .product-card:hover {
            transform: translateY(-3px);
        }

        .product-card img {
            max-width: 100%;
            height: 150px;
            object-fit: contain;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .product-card h3 {
            font-size: 18px;
            margin-top: 0;
            color: var(--primary-purple);
        }

        .product-card p {
            font-size: 15px;
            color: #555;
            margin-bottom: 5px;
        }
        .product-card .stock-info {
            font-weight: 600;
            color: #007bff;
        }

        .product-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .product-filters input, .product-filters select {
            flex: 1;
            min-width: 150px;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }


        /* POS Specific */
        .pos-input, .cart-summary, .report-filters, .setting-item, .ledger-entry-form {
            margin-bottom: 25px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 10px;
            border: 1px solid #eee;
            box-shadow: 0 1px 5px var(--shadow-light);
        }

        .pos-input {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        .pos-input input, .pos-input select, .pos-input button {
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            font-size: 15px;
        }
        .pos-input input {
            flex-grow: 1;
        }
        .pos-input button {
            background-color: var(--primary-purple);
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .pos-input button:hover {
            background-color: var(--dark-purple);
        }
        .search-results-container {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-top: 10px;
            background-color: white;
            box-shadow: 0 2px 5px var(--shadow-light);
        }
        .search-results-container div {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .search-results-container div:hover {
            background-color: #f0f0f0;
        }

        #pos-cart-table input[type="number"] {
            width: 70px;
            padding: 5px;
            margin: 0;
            font-size: 14px;
            text-align: center;
        }

        .cart-summary {
            font-size: 16px;
            font-weight: 500;
        }
        .cart-summary p {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .cart-summary span {
            font-weight: 700;
            color: var(--primary-purple);
        }
        .cart-summary label {
            width: auto;
            margin-right: 10px;
        }
        .cart-summary input {
            width: 120px;
            display: inline-block;
            margin-bottom: 10px;
        }
        .cart-summary #customer-info-fields label,
        .cart-summary #customer-info-fields input {
            display: block;
            width: calc(100% - 24px);
        }


        /* Report Filters */
        .report-filters {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            flex-wrap: wrap;
        }
        .report-filters > div {
            flex: 1;
            min-width: 180px;
        }
        .report-filters label {
            margin-bottom: 5px;
        }
        .report-filters input, .report-filters select {
            width: 100%;
            margin-bottom: 0; /* Override default form margin */
        }
        .report-filters button {
            padding: 10px 20px;
            font-size: 16px;
            min-width: 100px;
            background-color: var(--primary-purple);
        }
        .report-filters button:hover {
            background-color: var(--dark-purple);
        }

        #sales-report-summary {
            background-color: #e0f2ff;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 5px solid #007bff;
            font-size: 17px;
            font-weight: 600;
            color: #0056b3;
        }
        #sales-report-summary span {
            color: var(--primary-purple);
            font-size: 20px;
        }

        #sales-report-table ul {
            list-style: none;
            padding: 0;
            margin: 0;
            font-size: 13px;
            color: #555;
        }
        #sales-report-table ul li {
            margin-bottom: 3px;
        }
        #sales-report-table tr.return-row {
            background-color: #fff0f0 !important; /* Light red for returns */
            color: #dc3545;
        }
        #sales-report-table tr.return-row td {
            color: #dc3545;
        }


        /* Dues Management */
        #dues-section p {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--primary-purple);
        }
        #dues-section p span {
            font-size: 22px;
        }

        /* Returns Management */
        .return-input {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .return-input input {
            flex-grow: 1;
            min-width: 200px;
            margin-bottom: 0;
        }
        .return-input button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 15px;
        }
        .return-input button:hover {
            background-color: #0056b3;
        }

        #return-details-container h3, #return-details-container h4 {
            color: var(--primary-purple);
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 20px;
        }
        #return-details-container p {
            font-size: 16px;
            margin-bottom: 5px;
        }
        #return-details-container span {
            font-weight: 600;
            color: var(--dark-purple);
        }
        #return-items-table input[type="number"] {
            width: 60px;
            padding: 5px;
            text-align: center;
            margin: 0;
        }
        #process-return-btn {
            background-color: #28a745;
            margin-top: 20px;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 6px;
        }
        #process-return-btn:hover {
            background-color: #218838;
        }

        /* User Management */
        #add-user-form-container {
            margin-top: 20px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 10px;
            border: 1px solid #eee;
            box-shadow: 0 1px 5px var(--shadow-light);
        }
        #add-user-form-container h3 {
            color: var(--primary-purple);
            margin-top: 0;
            margin-bottom: 15px;
        }

        /* Settings */
        .setting-item {
            margin-bottom: 25px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 10px;
            border: 1px solid #eee;
            box-shadow: 0 1px 5px var(--shadow-light);
        }
        .setting-item h3 {
            color: var(--primary-purple);
            margin-top: 0;
            margin-bottom: 15px;
        }

        /* Ledger Section (New) */
        .ledger-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .ledger-summary .summary-card {
            background: linear-gradient(135deg, #007bff, #0056b3); /* Blue gradient */
        }
        .ledger-summary .summary-card.expense {
            background: linear-gradient(135deg, #fd7e14, #e65c00); /* Orange gradient */
        }
        .ledger-entry-form {
            margin-top: 20px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 10px;
            border: 1px solid #eee;
            box-shadow: 0 1px 5px var(--shadow-light);
        }
        .ledger-entry-form h3 {
            color: var(--primary-purple);
            margin-top: 0;
            margin-bottom: 15px;
        }
        .ledger-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        .ledger-filters input[type="date"], .ledger-filters select {
            flex: 1;
            min-width: 150px;
            margin-bottom: 0;
        }
        .ledger-filters button {
            padding: 10px 15px;
            font-size: 15px;
        }

        /* Print Styles */
        @media print {
            body * {
                visibility: hidden;
            }
            #print-area, #print-area * {
                visibility: visible;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: auto;
                padding: 20px;
                box-sizing: border-box;
                background: white;
                color: black;
                font-family: 'Noto Sans Bengali', Arial, sans-serif;
            }
            #print-area h2, #print-area p, #print-area table {
                visibility: visible;
                color: black;
            }
            #print-area h2 { text-align: center; margin-bottom: 5px; font-size: 22px;}
            #print-area p { margin: 2px 0; font-size: 14px;}
            #print-area table {
                border-collapse: collapse;
                width: 100%;
                margin-top: 10px;
            }
            #print-area th, #print-area td {
                border: 1px solid black;
                padding: 8px;
                text-align: left;
                font-size: 13px;
            }
            #print-area hr { border: 0; border-top: 1px dashed #ccc; margin: 10px 0; }
        }
    </style>
</head>
<body>
    <div id="login-container">
        <h2>লগইন করুন</h2>
        <form id="login-form">
            <input type="text" id="username" placeholder="ইউজারনেম" required>
            <input type="password" id="password" placeholder="পাসওয়ার্ড" required>
            <button type="submit">লগইন</button>
            <p id="login-error-message" class="error-message"></p>
        </form>
    </div>

    <div id="app-container" style="display:none;">
        <div id="sidebar">
            <div class="app-logo">
                <img src="https://img.icons8.com/color/48/000000/t-shirt.png" alt="Logo">
                <h1 id="sidebar-app-title">ফ্যাশনফ্লো প্রো</h1>
            </div>
            <nav>
                <ul id="main-nav-ul">
                    <li id="nav-dashboard"><a href="#" data-section="dashboard"><i class="fas fa-th-large"></i> ড্যাশবোর্ড</a></li>
                    <li id="nav-products"><a href="#" data-section="products"><i class="fas fa-tshirt"></i> পণ্যসমূহ</a></li>
                    <li id="nav-pos"><a href="#" data-section="pos"><i class="fas fa-cash-register"></i> বিক্রয় (POS)</a></li>
                    <li id="nav-sales"><a href="#" data-section="sales"><i class="fas fa-chart-line"></i> বিক্রয় রিপোর্ট</a></li>
                    <li id="nav-dues"><a href="#" data-section="dues"><i class="fas fa-money-bill-wave"></i> বাকি টাকা</a></li>
                    <li id="nav-returns"><a href="#" data-section="returns"><i class="fas fa-undo-alt"></i> ফেরত পণ্য</a></li>
                    <li id="nav-ledger"><a href="#" data-section="ledger"><i class="fas fa-book"></i> লেজার</a></li> <li id="nav-users"><a href="#" data-section="users"><i class="fas fa-users"></i> ব্যবহারকারী</a></li>
                    <li id="nav-settings"><a href="#" data-section="settings"><i class="fas fa-cogs"></i> সেটিংস</a></li>
                </ul>
            </nav>
            <div class="logout-section">
                <button id="logout-btn"><i class="fas fa-sign-out-alt"></i> লগআউট</button>
            </div>
        </div>

        <div id="main-content">
            <div id="topbar">
                <h2 id="current-section-title">ড্যাশবোর্ড</h2>
                <div class="user-profile">
                    <div class="user-info">
                        <p><span id="greeting-text">শুভ সকাল,</span> <span id="current-user-display-name"></span>!</p>
                    </div>
                    <div class="user-avatar" id="user-avatar-display">
                        <img id="profile-img" src="https://img.icons8.com/officel/80/null/user.png" alt="User Avatar">
                    </div>
                </div>
            </div>

            <section id="dashboard-section" class="app-section active">
                <h2><i class="fas fa-th-large"></i> ড্যাশবোর্ড</h2>
                <div class="dashboard-summary">
                    <div class="summary-card">
                        <i class="fas fa-hand-holding-usd"></i>
                        <h3>আজকের নিট বিক্রি</h3>
                        <p id="today-total-sales">৳ 0</p>
                    </div>
                    <div class="summary-card">
                        <i class="fas fa-boxes"></i>
                        <h3>মোট স্টক আইটেম</h3>
                        <p id="total-stock-items">0</p>
                    </div>
                    <div class="summary-card">
                        <i class="fas fa-coins"></i>
                        <h3>মোট বকেয়া</h3>
                        <p id="total-dues">৳ 0</p>
                    </div>
                    <div class="summary-card">
                        <i class="fas fa-users"></i>
                        <h3>মোট ব্যবহারকারী</h3>
                        <p id="total-users">0</p>
                    </div>
                </div>
                <div class="recent-activities">
                    <h3>সাম্প্রতিক কার্যক্রম</h3>
                    <div id="recent-activities-list">
                        </div>
                </div>
                <div class="quick-actions">
                    <h3>দ্রুত একশন</h3>
                    <div class="quick-actions-grid">
                        <div class="quick-action-card" onclick="showSection('pos')">
                            <i class="fas fa-plus-circle"></i>
                            <h4>নতুন বিক্রি</h4>
                        </div>
                        <div class="quick-action-card" onclick="showSection('products')">
                            <i class="fas fa-box-open"></i>
                            <h4>পণ্য যোগ করুন</h4>
                        </div>
                        <div class="quick-action-card" onclick="showSection('sales')">
                            <i class="fas fa-exchange-alt"></i>
                            <h4>বিক্রয় রিপোর্ট</h4>
                        </div>
                        <div class="quick-action-card" onclick="showSection('users')">
                            <i class="fas fa-user-plus"></i>
                            <h4>ব্যবহারকারী</h4>
                        </div>
                    </div>
                </div>
            </section>

            <section id="products-section" class="app-section">
                <h2><i class="fas fa-tshirt"></i> পণ্যসমূহ</h2>
                <button id="add-product-btn" class="primary-btn"><i class="fas fa-plus"></i> নতুন পণ্য যোগ করুন</button>
                <div id="add-product-form-container" style="display:none;" class="app-section">
                    <h3><i class="fas fa-edit"></i> পণ্য যোগ/সম্পাদনা</h3>
                    <form id="add-product-form">
                        <label for="product-name">পণ্যের নাম:</label>
                        <input type="text" id="product-name" required>
                        <label for="product-category">ক্যাটাগরি:</label>
                        <input type="text" id="product-category" placeholder="শার্ট, প্যান্ট, শাড়ি">
                        <label for="product-purchase-price">ক্রয় মূল্য (৳):</label>
                        <input type="number" id="product-purchase-price" step="0.01" min="0" value="0" required>
                        <label for="product-price">বিক্রয় মূল্য (৳):</label>
                        <input type="number" id="product-price" step="0.01" min="0" value="0" required>
                        <label for="product-stock-s">স্টক (S):</label>
                        <input type="number" id="product-stock-s" value="0" min="0">
                        <label for="product-stock-m">স্টক (M):</label>
                        <input type="number" id="product-stock-m" value="0" min="0">
                        <label for="product-stock-l">স্টক (L):</label>
                        <input type="number" id="product-stock-l" value="0" min="0">
                        <label for="product-stock-xl">স্টক (XL):</label>
                        <input type="number" id="product-stock-xl" value="0" min="0">
                        <label for="product-image">ছবি URL (ঐচ্ছিক):</label>
                        <input type="text" id="product-image" placeholder="https://example.com/image.jpg">
                        <button type="submit" class="primary-btn"><i class="fas fa-save"></i> সংরক্ষণ করুন</button>
                        <button type="button" class="cancel-btn"><i class="fas fa-times"></i> বাতিল করুন</button>
                    </form>
                </div>

                <h3><i class="fas fa-list"></i> সকল পণ্য</h3>
                <div class="product-filters">
                    <input type="text" id="product-search" placeholder="পণ্য খুঁজুন (নাম বা ID)...">
                    <select id="product-category-filter">
                        <option value="">সকল ক্যাটাগরি</option>
                        </select>
                </div>
                <div id="product-list" class="product-grid">
                    </div>
            </section>

            <section id="pos-section" class="app-section">
                <h2><i class="fas fa-cash-register"></i> বিক্রয় পয়েন্ট (POS)</h2>
                <div class="pos-input">
                    <input type="text" id="pos-product-search" placeholder="পণ্য খুঁজুন (নাম বা ID)">
                    <select id="pos-product-size-select">
                        <option value="">সাইজ নির্বাচন করুন</option>
                        </select>
                    <button id="pos-add-to-cart-btn"><i class="fas fa-cart-plus"></i> কার্টে যোগ করুন</button>
                </div>
                <div id="search-results-container" class="search-results-container">
                    </div>

                <h3><i class="fas fa-shopping-cart"></i> বিক্রয় কার্ট</h3>
                <table id="pos-cart-table">
                    <thead>
                        <tr>
                            <th>পণ্য</th>
                            <th>সাইজ</th>
                            <th>পরিমাণ</th>
                            <th>একক মূল্য</th>
                            <th>মোট</th>
                            <th>একশন</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
                <div class="cart-summary">
                    <p>মোট কার্ট মূল্য: <span id="cart-subtotal">৳ 0</span></p>
                    <label for="discount-amount">ডিসকাউন্ট (৳):</label>
                    <input type="number" id="discount-amount" value="0" min="0">
                    <p>চূড়ান্ত মূল্য: <span id="cart-final-total">৳ 0</span></p>
                </div>

                <h3><i class="fas fa-money-check-alt"></i> পেমেন্ট</h3>
                <form id="pos-payment-form">
                    <label for="payment-method">পেমেন্টের ধরণ:</label>
                    <select id="payment-method" required>
                        <option value="cash">নগদ</option>
                        <option value="card">কার্ড</option>
                        <option value="bKash">বিকাশ</option>
                        <option value="nagad">নগদ (মোবাইল)</option>
                        <option value="due">বাকিতে</option>
                    </select>
                    <div id="customer-info-fields" style="display:none;">
                        <label for="customer-name">কাস্টমারের নাম (বাকি নিলে):</label>
                        <input type="text" id="customer-name">
                        <label for="customer-phone">কাস্টমারের ফোন (বাকি নিলে):</label>
                        <input type="text" id="customer-phone">
                    </div>
                    <button type="submit" id="complete-sale-btn" class="primary-btn"><i class="fas fa-check-circle"></i> বিক্রয় সম্পন্ন করুন</button>
                    <button type="button" id="print-bill-btn" style="display:none;" class="primary-btn"><i class="fas fa-print"></i> বিল প্রিন্ট করুন</button>
                </form>
            </section>

            <section id="sales-section" class="app-section">
                <h2><i class="fas fa-chart-line"></i> বিক্রয় রিপোর্ট</h2>
                <div class="report-filters">
                    <div>
                        <label for="sales-report-date">তারিখ অনুযায়ী:</label>
                        <input type="date" id="sales-report-date">
                    </div>
                    <div>
                        <label for="sales-report-seller">বিক্রয়কারী অনুযায়ী:</label>
                        <select id="sales-report-seller">
                            <option value="">সকল সেলার</option>
                            </select>
                    </div>
                    <button id="filter-sales-report" class="primary-btn"><i class="fas fa-filter"></i> ফিল্টার</button>
                </div>
                <div id="sales-report-summary">
                    <h3>নির্বাচিত সময়ের মোট নিট বিক্রয়: <span id="filtered-sales-total">৳ 0</span></h3>
                    <p id="filtered-sales-profit" style="font-size: 16px; font-weight: normal; color: #28a745; margin-top: 5px;"><i class="fas fa-hand-holding-usd"></i> মোট লাভ: ৳ 0</p>
                </div>
                <table id="sales-report-table">
                    <thead>
                        <tr>
                            <th>বিল আইডি</th>
                            <th>তারিখ ও সময়</th>
                            <th>বিক্রয়কারী</th>
                            <th>কাস্টমার</th>
                            <th>মোট টাকা</th>
                            <th>লাভ</th>
                            <th>পেমেন্ট ধরণ</th>
                            <th>লেনদেন</th>
                            <th>পণ্যসমূহ</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </section>

            <section id="dues-section" class="app-section">
                <h2><i class="fas fa-money-bill-wave"></i> বাকি টাকা ব্যবস্থাপনা</h2>
                <p>মোট বকেয়া: <span id="total-dues-amount">৳ 0</span></p>
                <table id="dues-list-table">
                    <thead>
                        <tr>
                            <th>কাস্টমারের নাম</th>
                            <th>ফোন নম্বর</th>
                            <th>বিল আইডি</th>
                            <th>মোট বকেয়া</th>
                            <th>বাকি ছিল</th>
                            <th>পরিশোধিত</th>
                            <th>একশন</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </section>

            <section id="returns-section" class="app-section">
                <h2><i class="fas fa-undo-alt"></i> ফেরত পণ্য ব্যবস্থাপনা</h2>
                <div class="return-input">
                    <input type="text" id="return-sale-id" placeholder="বিক্রয় আইডি বা পণ্যের নাম">
                    <button id="search-sale-for-return" class="primary-btn"><i class="fas fa-search"></i> খুঁজুন</button>
                </div>
                <div id="return-details-container" style="display:none;" class="app-section">
                    <h3><i class="fas fa-info-circle"></i> রিটার্নের বিস্তারিত</h3>
                    <p>বিক্রয় আইডি: <span id="return-sale-id-display"></span></p>
                    <p>মূল বিক্রয় মূল্য: <span id="return-sale-total-display"></span></p>
                    <h4><i class="fas fa-box-open"></i> ফেরতযোগ্য পণ্য</h4>
                    <table id="return-items-table">
                        <thead>
                            <tr>
                                <th>পণ্য</th>
                                <th>সাইজ</th>
                                <th>মূল পরিমাণ</th>
                                <th>একক মূল্য</th>
                                <th>ফেরত</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                    <p style="font-size: 18px; font-weight: 600; margin-top: 20px;">ফেরতযোগ্য টাকা: <span id="refundable-amount" style="color: #dc3545;">৳ 0</span></p>
                    <button id="process-return-btn" class="danger-btn"><i class="fas fa-check-circle"></i> রিটার্ন প্রক্রিয়া করুন</button>
                </div>
            </section>

            <section id="ledger-section" class="app-section">
                <h2><i class="fas fa-book"></i> লেজার</h2>
                <div class="ledger-summary">
                    <div class="summary-card">
                        <i class="fas fa-dollar-sign"></i>
                        <h3>মোট অন্যান্য আয়</h3>
                        <p id="total-other-income">৳ 0</p>
                    </div>
                    <div class="summary-card expense">
                        <i class="fas fa-money-bill-alt"></i>
                        <h3>মোট খরচ</h3>
                        <p id="total-expenses">৳ 0</p>
                    </div>
                    <div class="summary-card" style="background: linear-gradient(135deg, #28a745, #218838);">
                        <i class="fas fa-balance-scale"></i>
                        <h3>নিট লেজার ব্যালেন্স</h3>
                        <p id="net-ledger-balance">৳ 0</p>
                    </div>
                </div>

                <div class="ledger-entry-form">
                    <h3><i class="fas fa-plus-circle"></i> নতুন লেনদেন যোগ করুন</h3>
                    <form id="add-ledger-entry-form">
                        <label for="ledger-type">লেনদেনের ধরণ:</label>
                        <select id="ledger-type" required>
                            <option value="expense">খরচ</option>
                            <option value="income">অন্যান্য আয়</option>
                        </select>
                        <label for="ledger-description">বিবরণ:</label>
                        <input type="text" id="ledger-description" placeholder="বিদ্যুৎ বিল, স্টাফ বেতন, ইত্যাদি" required>
                        <label for="ledger-amount">পরিমাণ (৳):</label>
                        <input type="number" id="ledger-amount" step="0.01" min="0" required>
                        <label for="ledger-date">তারিখ:</label>
                        <input type="date" id="ledger-date" required>
                        <button type="submit" class="primary-btn"><i class="fas fa-plus"></i> যোগ করুন</button>
                        <button type="button" class="cancel-btn" id="cancel-ledger-entry"><i class="fas fa-times"></i> বাতিল</button>
                    </form>
                </div>

                <h3><i class="fas fa-history"></i> সকল লেনদেন</h3>
                <div class="ledger-filters">
                    <div>
                        <label for="ledger-filter-date">তারিখ অনুযায়ী:</label>
                        <input type="date" id="ledger-filter-date">
                    </div>
                    <div>
                        <label for="ledger-filter-type">ধরণ অনুযায়ী:</label>
                        <select id="ledger-filter-type">
                            <option value="">সকল</option>
                            <option value="expense">খরচ</option>
                            <option value="income">অন্যান্য আয়</option>
                        </select>
                    </div>
                    <button id="filter-ledger" class="primary-btn"><i class="fas fa-filter"></i> ফিল্টার</button>
                </div>
                <table id="ledger-table">
                    <thead>
                        <tr>
                            <th>তারিখ</th>
                            <th>ধরণ</th>
                            <th>বিবরণ</th>
                            <th>পরিমাণ</th>
                            <th>একশন</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </section>


            <section id="users-section" class="app-section">
                <h2><i class="fas fa-users"></i> ব্যবহারকারী ব্যবস্থাপনা</h2>
                <button id="add-user-btn" class="primary-btn"><i class="fas fa-user-plus"></i> নতুন ব্যবহারকারী যোগ করুন</button>
                <div id="add-user-form-container" style="display:none;" class="app-section">
                    <h3><i class="fas fa-user-edit"></i> ব্যবহারকারী যোগ/সম্পাদনা</h3>
                    <form id="add-user-form">
                        <label for="new-username">ইউজারনেম:</label>
                        <input type="text" id="new-username" required>
                        <label for="new-password">পাসওয়ার্ড:</label>
                        <input type="password" id="new-password" required>
                        <label for="new-user-role">ভূমিকা:</label>
                        <select id="new-user-role" required>
                            <option value="seller">সেলার</option>
                            <option value="admin">অ্যাডমিন</option>
                        </select>
                        <label for="new-user-display-name">প্রোফাইল নাম (প্রোফাইল):</label>
                        <input type="text" id="new-user-display-name" placeholder="আপনার পুরো নাম">
                        <label for="new-user-profile-image">প্রোফাইল ছবি URL (ঐচ্ছিক):</label>
                        <input type="text" id="new-user-profile-image" placeholder="https://img.icons8.com/officel/80/null/user.png">

                        <button type="submit" class="primary-btn"><i class="fas fa-save"></i> সংরক্ষণ করুন</button>
                        <button type="button" class="cancel-btn"><i class="fas fa-times"></i> বাতিল করুন</button>
                    </form>
                </div>
                <h3><i class="fas fa-list"></i> সকল ব্যবহারকারী</h3>
                <table id="user-list-table">
                    <thead>
                        <tr>
                            <th>আইডি</th>
                            <th>ইউজারনেম</th>
                            <th>প্রোফাইল নাম</th>
                            <th>ভূমিকা</th>
                            <th>একশন</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </section>

            <section id="settings-section" class="app-section">
                <h2><i class="fas fa-cogs"></i> সেটিংস</h2>
                <div class="setting-item">
                    <h3><i class="fas fa-store"></i> দোকানের তথ্য</h3>
                    <form id="shop-info-form">
                        <label for="shop-name">দোকানের নাম:</label>
                        <input type="text" id="shop-name" value="আমার কাপড়ের দোকান" required>
                        <label for="shop-address">ঠিকানা:</label>
                        <input type="text" id="shop-address" value="গুনাগুরী, বাঁশখালী, চট্টগ্রাম" required>
                        <button type="submit" class="primary-btn"><i class="fas fa-save"></i> আপডেট করুন</button>
                    </form>
                </div>
                <div class="setting-item">
                    <h3><i class="fas fa-history"></i> সফটওয়্যার ডেটা রিসেট</h3>
                    <p>এই অপশনটি সফটওয়্যারের সকল ডেটা মুছে দেবে। এই কাজটি অপরিবর্তনীয়!</p>
                    <button id="reset-all-data-btn" class="danger-btn"><i class="fas fa-exclamation-triangle"></i> সকল ডেটা রিসেট করুন</button>
                </div>
            </section>
        </div>
    </div>

    <script>
        // --- Global Data Arrays (loaded from Local Storage) ---
        let products = [];
        let users = [];
        let sales = []; // This array will now hold both sales and return transactions
        let dues = [];
        let ledgerEntries = []; // New array for ledger (expenses/other income)
        let shopSettings = {
            name: "ফ্যাশনফ্লো প্রো",
            address: "গুনাগুরী, বাঁশখালী, চট্টগ্রাম"
        };

        // --- Current User and Cart State ---
        let currentUser = null;
        let currentCart = []; // { productId, name, size, quantity, unitPrice, purchasePrice }

        // --- Utility Functions for Local Storage ---
        function loadData(key, defaultValue) {
            const data = localStorage.getItem(key);
            try {
                return data ? JSON.parse(data) : defaultValue;
            } catch (e) {
                console.error(`Error parsing data for key ${key}:`, e);
                return defaultValue;
            }
        }

        function saveData(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }

        function generateUniqueId(prefix) {
            return prefix + Date.now().toString(36) + Math.random().toString(36).substring(2, 5);
        }

        // --- Data Initialization ---
        function initializeData() {
            products = loadData('products', []);
            users = loadData('users', []);
            sales = loadData('sales', []);
            dues = loadData('dues', []);
            ledgerEntries = loadData('ledgerEntries', []); // Load ledger entries
            shopSettings = loadData('shopSettings', { name: "ফ্যাশনফ্লো প্রো", address: "গুনাগুরী, বাঁশখালী, চট্টগ্রাম" });

            // Add default admin user if no users exist
            if (users.length === 0) {
                users.push({
                    id: generateUniqueId('U'),
                    username: 'admin',
                    password: 'adminpassword', // In a real app, never store plain passwords!
                    role: 'admin',
                    displayName: 'অ্যাডমিন',
                    profileImage: 'https://img.icons8.com/color/96/admin-settings-male.png'
                });
                // Add a default seller for testing
                users.push({
                    id: generateUniqueId('U'),
                    username: 'seller1',
                    password: 'sellerpassword',
                    role: 'seller',
                    displayName: 'বিক্রয়কর্মী ১',
                    profileImage: 'https://img.icons8.com/color/96/seller.png'
                });
                saveData('users', users);
            }
            // Set initial shop settings
            document.getElementById('shop-name').value = shopSettings.name;
            document.getElementById('shop-address').value = shopSettings.address;
            document.getElementById('sidebar-app-title').textContent = shopSettings.name; // Update sidebar title
        }

        // --- UI Element References ---
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const loginErrorMessage = document.getElementById('login-error-message');
        const logoutBtn = document.getElementById('logout-btn');
        const mainNavUl = document.getElementById('main-nav-ul');
        const currentSectionTitle = document.getElementById('current-section-title');
        const greetingText = document.getElementById('greeting-text');
        const currentUserDisplayName = document.getElementById('current-user-display-name');
        const profileImg = document.getElementById('profile-img');
        const userAvatarDisplay = document.getElementById('user-avatar-display');

        // Section elements
        const dashboardSection = document.getElementById('dashboard-section');
        const productsSection = document.getElementById('products-section');
        const posSection = document.getElementById('pos-section');
        const salesSection = document.getElementById('sales-section');
        const duesSection = document.getElementById('dues-section');
        const returnsSection = document.getElementById('returns-section');
        const ledgerSection = document.getElementById('ledger-section'); // New
        const usersSection = document.getElementById('users-section');
        const settingsSection = document.getElementById('settings-section');

        // Product Section Elements
        const addProductBtn = document.getElementById('add-product-btn');
        const addProductFormContainer = document.getElementById('add-product-form-container');
        const addProductForm = document.getElementById('add-product-form');
        const productList = document.getElementById('product-list');
        const productSearch = document.getElementById('product-search');
        const productCategoryFilter = document.getElementById('product-category-filter');
        const productPurchasePriceInput = document.getElementById('product-purchase-price'); // New

        // POS Section Elements
        const posProductSearch = document.getElementById('pos-product-search');
        const posProductSizeSelect = document.getElementById('pos-product-size-select');
        const searchResultsContainer = document.getElementById('search-results-container');
        const posAddToCartBtn = document.getElementById('pos-add-to-cart-btn');
        const posCartTableBody = document.querySelector('#pos-cart-table tbody');
        const cartSubtotalSpan = document.getElementById('cart-subtotal');
        const discountAmountInput = document.getElementById('discount-amount');
        const cartFinalTotalSpan = document.getElementById('cart-final-total');
        const posPaymentForm = document.getElementById('pos-payment-form');
        const paymentMethodSelect = document.getElementById('payment-method');
        const customerInfoFields = document.getElementById('customer-info-fields');
        const customerNameInput = document.getElementById('customer-name');
        const customerPhoneInput = document.getElementById('customer-phone');
        const completeSaleBtn = document.getElementById('complete-sale-btn');
        const printBillBtn = document.getElementById('print-bill-btn');

        // Sales Report Elements
        const salesReportDateInput = document.getElementById('sales-report-date');
        const salesReportSellerSelect = document.getElementById('sales-report-seller');
        const filterSalesReportBtn = document.getElementById('filter-sales-report');
        const salesReportTableBody = document.querySelector('#sales-report-table tbody');
        const filteredSalesTotalSpan = document.getElementById('filtered-sales-total');
        const filteredSalesProfitSpan = document.getElementById('filtered-sales-profit'); // New

        // Dues Section Elements
        const duesListTableBody = document.querySelector('#dues-list-table tbody');
        const totalDuesAmountSpan = document.getElementById('total-dues-amount');

        // Returns Section Elements
        const returnSaleIdInput = document.getElementById('return-sale-id');
        const searchSaleForReturnBtn = document.getElementById('search-sale-for-return');
        const returnDetailsContainer = document.getElementById('return-details-container');
        const returnSaleIdDisplay = document.getElementById('return-sale-id-display');
        const returnSaleTotalDisplay = document.getElementById('return-sale-total-display');
        const returnItemsTableBody = document.querySelector('#return-items-table tbody');
        const refundableAmountSpan = document.getElementById('refundable-amount');
        const processReturnBtn = document.getElementById('process-return-btn');

        // Ledger Section Elements (New)
        const totalOtherIncomeSpan = document.getElementById('total-other-income');
        const totalExpensesSpan = document.getElementById('total-expenses');
        const netLedgerBalanceSpan = document.getElementById('net-ledger-balance');
        const addLedgerEntryForm = document.getElementById('add-ledger-entry-form');
        const ledgerTypeSelect = document.getElementById('ledger-type');
        const ledgerDescriptionInput = document.getElementById('ledger-description');
        const ledgerAmountInput = document.getElementById('ledger-amount');
        const ledgerDateInput = document.getElementById('ledger-date');
        const ledgerFilterDateInput = document.getElementById('ledger-filter-date');
        const ledgerFilterTypeSelect = document.getElementById('ledger-filter-type');
        const filterLedgerBtn = document.getElementById('filter-ledger');
        const ledgerTableBody = document.querySelector('#ledger-table tbody');

        // User Management Elements
        const addUserBtn = document.getElementById('add-user-btn');
        const addUserFormContainer = document.getElementById('add-user-form-container');
        const addUserForm = document.getElementById('add-user-form');
        const userListTableBody = document.querySelector('#user-list-table tbody');
        const newUserDisplayNameInput = document.getElementById('new-user-display-name'); // New
        const newUserProfileImageInput = document.getElementById('new-user-profile-image'); // New

        // Settings Elements
        const shopInfoForm = document.getElementById('shop-info-form');
        const resetAllDataBtn = document.getElementById('reset-all-data-btn');

        // --- Helper Functions ---
        function showSection(sectionId) {
            document.querySelectorAll('.app-section').forEach(section => {
                section.style.display = 'none';
                section.classList.remove('active');
            });
            document.getElementById(`${sectionId}-section`).style.display = 'block';
            document.getElementById(`${sectionId}-section`).classList.add('active');

            document.querySelectorAll('nav ul li a').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`nav ul li a[data-section="${sectionId}"]`).classList.add('active');

            // Update topbar title
            const sectionTitleMap = {
                'dashboard': 'ড্যাশবোর্ড',
                'products': 'পণ্যসমূহ',
                'pos': 'বিক্রয় (POS)',
                'sales': 'বিক্রয় রিপোর্ট',
                'dues': 'বাকি টাকা',
                'returns': 'ফেরত পণ্য',
                'ledger': 'লেজার',
                'users': 'ব্যবহারকারী',
                'settings': 'সেটিংস'
            };
            currentSectionTitle.textContent = sectionTitleMap[sectionId] || 'ফ্যাশনফ্লো প্রো';


            if (sectionId === 'dashboard') {
                renderDashboard();
            } else if (sectionId === 'products') {
                renderProductList();
                populateCategoryFilter();
            } else if (sectionId === 'pos') {
                currentCart = []; // Clear previous cart
                renderCart();
                updateCartTotal();
                posProductSearch.value = ''; // Clear search input
                posProductSizeSelect.innerHTML = '<option value="">সাইজ নির্বাচন করুন</option>'; // Reset size select
                printBillBtn.style.display = 'none'; // Hide print button
                posPaymentForm.reset(); // Reset payment form
                customerInfoFields.style.display = 'none';
                discountAmountInput.value = 0;
            } else if (sectionId === 'sales') {
                const today = new Date().toISOString().split('T')[0];
                salesReportDateInput.value = today; // Set today's date
                renderSalesReport(today, ''); // Show today's sales by default
                populateSellerFilter();
            } else if (sectionId === 'dues') {
                renderDuesList();
            } else if (sectionId === 'returns') {
                returnDetailsContainer.style.display = 'none';
                returnSaleIdInput.value = '';
            } else if (sectionId === 'ledger') {
                const today = new Date().toISOString().split('T')[0];
                ledgerDateInput.value = today; // Set today's date for new entry
                ledgerFilterDateInput.value = ''; // Clear filter date
                ledgerFilterTypeSelect.value = ''; // Clear filter type
                renderLedger();
            }
            else if (sectionId === 'users') {
                renderUserList();
            }
        }

        function updateShopTitle(name) {
            document.getElementById('sidebar-app-title').textContent = name;
        }

        function updateDashboardSummary() {
            const today = new Date();
            const todaySales = sales.filter(transaction => {
                const transactionDate = new Date(transaction.timestamp);
                return transactionDate.getDate() === today.getDate() &&
                       transactionDate.getMonth() === today.getMonth() &&
                       transactionDate.getFullYear() === today.getFullYear() &&
                       transaction.type === 'sale'; // Only consider actual sales
            }).reduce((sum, sale) => sum + sale.finalAmount, 0);

            const todayReturns = sales.filter(transaction => {
                const transactionDate = new Date(transaction.timestamp);
                return transactionDate.getDate() === today.getDate() &&
                       transactionDate.getMonth() === today.getMonth() &&
                       transactionDate.getFullYear() === today.getFullYear() &&
                       transaction.type === 'return'; // Only consider returns
            }).reduce((sum, returnTransaction) => sum + returnTransaction.finalAmount, 0); // finalAmount for returns is negative

            document.getElementById('today-total-sales').textContent = `৳ ${(todaySales + todayReturns).toLocaleString()}`;


            let totalStock = 0;
            products.forEach(p => {
                for (const size in p.sizes) {
                    totalStock += p.sizes[size];
                }
            });
            document.getElementById('total-stock-items').textContent = totalStock;

            const totalDuesAmount = dues.reduce((sum, due) => sum + due.remainingAmount, 0);
            document.getElementById('total-dues').textContent = `৳ ${totalDuesAmount.toLocaleString()}`;

            document.getElementById('total-users').textContent = users.length;
        }

        function renderRecentActivities() {
            const recentActivitiesList = document.getElementById('recent-activities-list');
            recentActivitiesList.innerHTML = '';

            // Combine sales and returns for recent activities
            const allTransactions = [...sales].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0, 5); // Get latest 5

            if (allTransactions.length === 0) {
                recentActivitiesList.innerHTML = '<p>কোনো সাম্প্রতিক কার্যক্রম নেই।</p>';
                return;
            }

            allTransactions.forEach(t => {
                let activityText = '';
                let timeAgo = moment(t.timestamp).fromNow(); // Using moment.js for "X minutes ago"

                if (t.type === 'sale') {
                    activityText = `নতুন বিক্রি #${t.saleId.substring(0, 7)} - ${t.items[0]?.name || 'পণ্য'}`;
                } else if (t.type === 'return') {
                    activityText = `ফেরত - ${t.items[0]?.name || 'পণ্য'} (${t.items[0]?.size || ''})`;
                } else if (t.type === 'product_added') { // Example for future activity types
                    activityText = `পণ্য যোগ: ${t.productName}`;
                } else if (t.type === 'stock_update') {
                    activityText = `স্টক আপডেট - ${t.productName} (${t.size})`;
                } else if (t.type === 'user_registered') {
                    activityText = `নতুন ব্যবহারকারী রেজিস্ট্রেশন: ${t.userName}`;
                }

                if (currentUser.role === 'seller' && t.sellerId !== currentUser.id && t.type !== 'user_registered') {
                    // Sellers only see their own sales/returns. All users see user registrations.
                    return;
                }

                const activityItem = document.createElement('div');
                activityItem.className = 'activity-item';
                activityItem.innerHTML = `
                    <span>${activityText}</span>
                    <span>${timeAgo}</span>
                `;
                recentActivitiesList.appendChild(activityItem);
            });
        }


        function renderDashboard() {
            updateDashboardSummary();
            renderRecentActivities();
        }


        // --- Login and Role Management ---
        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            const user = users.find(u => u.username === username && u.password === password);

            if (user) {
                currentUser = user;
                loginContainer.style.display = 'none';
                appContainer.style.display = 'flex';
                renderAppBasedOnRole(user.role);
                updateUserProfileDisplay(); // Update display name and image
                showSection('dashboard');
                updateShopTitle(shopSettings.name); // Update title with saved shop name
            } else {
                loginErrorMessage.textContent = 'ভুল ইউজারনেম বা পাসওয়ার্ড।';
            }
        }

        function renderAppBasedOnRole(role) {
            document.querySelectorAll('nav ul li').forEach(li => li.style.display = 'none');

            // Show common nav items
            document.getElementById('nav-dashboard').style.display = 'list-item';
            document.getElementById('nav-products').style.display = 'list-item';
            document.getElementById('nav-pos').style.display = 'list-item';
            document.getElementById('nav-sales').style.display = 'list-item';
            document.getElementById('nav-dues').style.display = 'list-item';
            document.getElementById('nav-returns').style.display = 'list-item';
            document.getElementById('nav-ledger').style.display = 'list-item'; // New ledger nav

            if (role === 'admin') {
                document.getElementById('nav-users').style.display = 'list-item';
                document.getElementById('nav-settings').style.display = 'list-item';
                document.getElementById('add-product-btn').style.display = 'inline-block'; // Admin can add products
            } else if (role === 'seller') {
                document.getElementById('nav-users').style.display = 'none';
                document.getElementById('nav-settings').style.display = 'none';
                document.getElementById('add-product-btn').style.display = 'none'; // Seller cannot add products
            }
        }

        function updateUserProfileDisplay() {
            if (currentUser) {
                // Determine greeting based on time of day
                const hour = new Date().getHours();
                let greeting = '';
                if (hour < 12) {
                    greeting = 'শুভ সকাল,';
                } else if (hour < 18) {
                    greeting = 'শুভ বিকাল,';
                } else {
                    greeting = 'শুভ সন্ধ্যা,';
                }
                greetingText.textContent = greeting;
                currentUserDisplayName.textContent = currentUser.displayName || currentUser.username;
                profileImg.src = currentUser.profileImage || 'https://img.icons8.com/officel/80/null/user.png';
            }
        }

        function handleLogout() {
            currentUser = null;
            loginContainer.style.display = 'block';
            appContainer.style.display = 'none';
            loginForm.reset();
            loginErrorMessage.textContent = '';
        }

        // --- Product Management ---
        function renderProductList(filterText = '', categoryFilter = '') {
            productList.innerHTML = '';
            let filteredProducts = products;

            if (filterText) {
                const lowerFilterText = filterText.toLowerCase();
                filteredProducts = filteredProducts.filter(p =>
                    p.name.toLowerCase().includes(lowerFilterText) || p.id.toLowerCase().includes(lowerFilterText)
                );
            }

            if (categoryFilter) {
                filteredProducts = filteredProducts.filter(p => p.category === categoryFilter);
            }

            if (filteredProducts.length === 0) {
                productList.innerHTML = '<p>কোনো পণ্য খুঁজে পাওয়া যায়নি।</p>';
                return;
            }

            filteredProducts.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                let totalStock = 0;
                for(const size in product.sizes) {
                    totalStock += product.sizes[size];
                }
                productCard.innerHTML = `
                    <img src="${product.imageUrl || 'https://via.placeholder.com/150?text=No+Image'}" alt="${product.name}">
                    <h3>${product.name}</h3>
                    <p>ক্যাটাগরি: ${product.category || 'N/A'}</p>
                    <p>ক্রয় মূল্য: ৳ ${product.purchasePrice?.toLocaleString() || 'N/A'}</p>
                    <p>বিক্রয় মূল্য: ৳ ${product.price.toLocaleString()}</p>
                    <p class="stock-info">স্টক: ${totalStock} পিস</p>
                    <div class="table-action-buttons">
                        <button data-id="${product.id}" class="edit-product-btn edit-btn"><i class="fas fa-edit"></i> সম্পাদনা</button>
                        <button data-id="${product.id}" class="delete-product-btn danger-btn"><i class="fas fa-trash-alt"></i> মুছুন</button>
                    </div>
                `;
                productList.appendChild(productCard);

                if (currentUser.role !== 'admin') {
                    productCard.querySelector('.table-action-buttons').style.display = 'none';
                }
            });

            document.querySelectorAll('.edit-product-btn').forEach(button => {
                button.addEventListener('click', (e) => editProduct(e.target.dataset.id));
            });
            document.querySelectorAll('.delete-product-btn').forEach(button => {
                button.addEventListener('click', (e) => deleteProduct(e.target.dataset.id));
            });
        }

        function populateCategoryFilter() {
            const categories = [...new Set(products.map(p => p.category).filter(Boolean))];
            productCategoryFilter.innerHTML = '<option value="">সকল ক্যাটাগরি</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                productCategoryFilter.appendChild(option);
            });
        }

        addProductBtn.addEventListener('click', () => {
            if (currentUser.role === 'admin') {
                addProductFormContainer.style.display = 'block';
                addProductForm.reset();
                addProductForm.dataset.editingId = '';
                document.getElementById('product-stock-s').value = 0;
                document.getElementById('product-stock-m').value = 0;
                document.getElementById('product-stock-l').value = 0;
                document.getElementById('product-stock-xl').value = 0;
                productPurchasePriceInput.value = 0; // Reset purchase price
            } else {
                alert('আপনার নতুন পণ্য যোগ করার অনুমতি নেই।');
            }
        });

        document.querySelectorAll('#add-product-form-container .cancel-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                addProductFormContainer.style.display = 'none';
                addProductForm.reset();
            });
        });

        addProductForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const id = addProductForm.dataset.editingId || generateUniqueId('P');
            const name = document.getElementById('product-name').value;
            const category = document.getElementById('product-category').value;
            const purchasePrice = parseFloat(productPurchasePriceInput.value); // New
            const price = parseFloat(document.getElementById('product-price').value);
            const stockS = parseInt(document.getElementById('product-stock-s').value) || 0;
            const stockM = parseInt(document.getElementById('product-stock-m').value) || 0;
            const stockL = parseInt(document.getElementById('product-stock-l').value) || 0;
            const stockXL = parseInt(document.getElementById('product-stock-xl').value) || 0;
            const imageUrl = document.getElementById('product-image').value;

            if (purchasePrice > price) {
                alert('ক্রয় মূল্য বিক্রয় মূল্যের চেয়ে বেশি হতে পারে না।');
                return;
            }

            const newProduct = {
                id,
                name,
                category,
                purchasePrice, // New
                price,
                imageUrl,
                sizes: { S: stockS, M: stockM, L: stockL, XL: stockXL }
            };

            if (addProductForm.dataset.editingId) {
                const index = products.findIndex(p => p.id === id);
                if (index !== -1) {
                    products[index] = { ...products[index], ...newProduct };
                    alert('পণ্য সফলভাবে আপডেট করা হয়েছে!');
                }
            } else {
                products.push(newProduct);
                alert('পণ্য সফলভাবে যোগ করা হয়েছে!');
            }

            saveData('products', products);
            renderProductList();
            populateCategoryFilter();
            addProductFormContainer.style.display = 'none';
            addProductForm.reset();
        });

        function editProduct(id) {
            if (currentUser.role !== 'admin') {
                alert('আপনার পণ্য সম্পাদনার অনুমতি নেই।');
                return;
            }
            const product = products.find(p => p.id === id);
            if (product) {
                addProductFormContainer.style.display = 'block';
                document.getElementById('product-name').value = product.name;
                document.getElementById('product-category').value = product.category;
                productPurchasePriceInput.value = product.purchasePrice || 0; // New
                document.getElementById('product-price').value = product.price;
                document.getElementById('product-stock-s').value = product.sizes.S || 0;
                document.getElementById('product-stock-m').value = product.sizes.M || 0;
                document.getElementById('product-stock-l').value = product.sizes.L || 0;
                document.getElementById('product-stock-xl').value = product.sizes.XL || 0;
                document.getElementById('product-image').value = product.imageUrl || '';
                addProductForm.dataset.editingId = product.id;
            }
        }

        function deleteProduct(id) {
            if (currentUser.role !== 'admin') {
                alert('আপনার পণ্য মুছে ফেলার অনুমতি নেই।');
                return;
            }
            if (confirm('আপনি কি নিশ্চিত এই পণ্যটি মুছে ফেলতে চান?')) {
                products = products.filter(p => p.id !== id);
                saveData('products', products);
                renderProductList();
                populateCategoryFilter();
                alert('পণ্য সফলভাবে মুছে ফেলা হয়েছে!');
            }
        }

        productSearch.addEventListener('input', (e) => renderProductList(e.target.value, productCategoryFilter.value));
        productCategoryFilter.addEventListener('change', (e) => renderProductList(productSearch.value, e.target.value));

        // --- POS (Point of Sale) Management ---
        posProductSearch.addEventListener('input', (e) => {
            const searchText = e.target.value.toLowerCase();
            searchResultsContainer.innerHTML = '';
            posProductSizeSelect.innerHTML = '<option value="">সাইজ নির্বাচন করুন</option>'; // Clear sizes when searching

            if (searchText.length < 2) return;

            const filtered = products.filter(p =>
                p.name.toLowerCase().includes(searchText) || p.id.toLowerCase().includes(searchText)
            );

            filtered.forEach(p => {
                const div = document.createElement('div');
                let totalStock = 0;
                for(const size in p.sizes) {
                    totalStock += p.sizes[size];
                }
                div.textContent = `${p.name} (ID: ${p.id}, ৳ ${p.price}, স্টক: ${totalStock} পিস)`;
                div.dataset.productId = p.id;
                div.addEventListener('click', () => {
                    posProductSearch.value = p.name;
                    searchResultsContainer.innerHTML = ''; // Clear search results
                    populatePosProductSizes(p.id); // Populate sizes for selected product
                });
                searchResultsContainer.appendChild(div);
            });
        });

        function populatePosProductSizes(productId) {
            posProductSizeSelect.innerHTML = '<option value="">সাইজ নির্বাচন করুন</option>'; // Reset
            const product = products.find(p => p.id === productId);
            if (product) {
                for (const size in product.sizes) {
                    if (product.sizes[size] > 0) { // Only show sizes that are in stock
                        const option = document.createElement('option');
                        option.value = size;
                        option.textContent = `${size} (স্টক: ${product.sizes[size]})`;
                        posProductSizeSelect.appendChild(option);
                    }
                }
            }
        }

        posAddToCartBtn.addEventListener('click', () => {
            const productNameOrId = posProductSearch.value;
            const selectedSize = posProductSizeSelect.value;
            const product = products.find(p => p.name === productNameOrId || p.id === productNameOrId);

            if (!product) {
                alert('পণ্য খুঁজে পাওয়া যায়নি।');
                return;
            }
            if (!selectedSize || selectedSize === '') {
                alert('অনুগ্রহ করে পণ্যের সাইজ নির্বাচন করুন।');
                return;
            }

            if (product.sizes[selectedSize] <= 0) {
                alert(`দুঃখিত! ${product.name} (${selectedSize} সাইজ) স্টকে নেই।`);
                return;
            }

            const existingCartItem = currentCart.find(item => item.productId === product.id && item.size === selectedSize);

            if (existingCartItem) {
                if (product.sizes[selectedSize] > existingCartItem.quantity) {
                    existingCartItem.quantity++;
                } else {
                    alert(`স্টকে ${product.name} (${selectedSize} সাইজের) পর্যাপ্ত নেই।`);
                    return;
                }
            } else {
                currentCart.push({
                    productId: product.id,
                    name: product.name,
                    size: selectedSize,
                    quantity: 1,
                    unitPrice: product.price,
                    purchasePrice: product.purchasePrice || 0 // Store purchase price for profit calculation
                });
            }
            renderCart();
            posProductSearch.value = ''; // Clear search input
            posProductSizeSelect.innerHTML = '<option value="">সাইজ নির্বাচন করুন</option>'; // Reset size select
        });

        function renderCart() {
            posCartTableBody.innerHTML = '';
            if (currentCart.length === 0) {
                const row = posCartTableBody.insertRow();
                const cell = row.insertCell(0);
                cell.colSpan = 6;
                cell.textContent = 'কার্ট খালি আছে।';
                return;
            }

            currentCart.forEach((item, index) => {
                const row = posCartTableBody.insertRow();
                row.insertCell(0).textContent = item.name;
                row.insertCell(1).textContent = item.size;

                const quantityCell = row.insertCell(2);
                const quantityInput = document.createElement('input');
                quantityInput.type = 'number';
                quantityInput.value = item.quantity;
                quantityInput.min = '1';
                quantityInput.style.width = '60px';
                quantityInput.addEventListener('change', (e) => {
                    const newQuantity = parseInt(e.target.value);
                    const product = products.find(p => p.id === item.productId);
                    if (product && product.sizes[item.size] >= newQuantity) {
                        item.quantity = newQuantity;
                        updateCartTotal();
                    } else {
                        alert(`স্টকে ${item.name} (${item.size} সাইজের) পর্যাপ্ত নেই।`);
                        e.target.value = item.quantity; // Revert
                    }
                });
                quantityCell.appendChild(quantityInput);

                const unitPriceCell = row.insertCell(3); // Cell for unit price
                const unitPriceInput = document.createElement('input'); // Input for editing unit price
                unitPriceInput.type = 'number';
                unitPriceInput.step = '0.01';
                unitPriceInput.min = '0';
                unitPriceInput.value = item.unitPrice;
                unitPriceInput.style.width = '80px';
                unitPriceInput.addEventListener('input', (e) => {
                    item.unitPrice = parseFloat(e.target.value) || 0;
                    updateCartTotal();
                });
                unitPriceCell.appendChild(unitPriceInput);

                row.insertCell(4).textContent = `৳ ${(item.quantity * item.unitPrice).toLocaleString()}`;
                const actionCell = row.insertCell(5);
                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'মুছুন';
                removeBtn.className = 'danger-btn';
                removeBtn.addEventListener('click', () => {
                    currentCart.splice(index, 1);
                    renderCart();
                });
                actionCell.appendChild(removeBtn);
            });
            updateCartTotal();
        }

        function updateCartTotal() {
            const subtotal = currentCart.reduce((sum, item) => sum + (item.quantity * item.unitPrice), 0);
            const discount = parseFloat(discountAmountInput.value) || 0;
            const finalTotal = Math.max(0, subtotal - discount);

            cartSubtotalSpan.textContent = `৳ ${subtotal.toLocaleString()}`;
            cartFinalTotalSpan.textContent = `৳ ${finalTotal.toLocaleString()}`;
        }

        discountAmountInput.addEventListener('input', updateCartTotal);

        paymentMethodSelect.addEventListener('change', (e) => {
            if (e.target.value === 'due') {
                customerInfoFields.style.display = 'block';
                customerNameInput.setAttribute('required', 'required');
                customerPhoneInput.setAttribute('required', 'required');
            } else {
                customerInfoFields.style.display = 'none';
                customerNameInput.removeAttribute('required');
                customerPhoneInput.removeAttribute('required');
            }
        });

        posPaymentForm.addEventListener('submit', (event) => {
            event.preventDefault();
            if (currentCart.length === 0) {
                alert('কার্টে কোনো পণ্য নেই!');
                return;
            }

            const saleId = generateUniqueId('S');
            const timestamp = new Date().toISOString();
            const sellerId = currentUser.id;
            const totalAmount = parseFloat(cartSubtotalSpan.textContent.replace('৳ ', '').replace(/,/g, ''));
            const discountAmount = parseFloat(discountAmountInput.value) || 0;
            const finalAmount = parseFloat(cartFinalTotalSpan.textContent.replace('৳ ', '').replace(/,/g, ''));
            const paymentMethod = paymentMethodSelect.value;
            const customerName = customerNameInput.value.trim() || 'ক্যাশ কাস্টমার';
            const customerPhone = customerPhoneInput.value.trim() || 'N/A';
            const status = (paymentMethod === 'due') ? 'বাকি' : 'সম্পূর্ণ';

            let totalProfit = 0;
            // Check stock and calculate profit before finalizing sale
            for (const item of currentCart) {
                const product = products.find(p => p.id === item.productId);
                if (!product || product.sizes[item.size] < item.quantity) {
                    alert(`দুঃখিত! ${item.name} (${item.size} সাইজ) স্টকে পর্যাপ্ত নেই।`);
                    return;
                }
                const itemProfit = (item.unitPrice - (product.purchasePrice || 0)) * item.quantity;
                totalProfit += itemProfit;
            }

            // Deduct stock
            currentCart.forEach(item => {
                const productIndex = products.findIndex(p => p.id === item.productId);
                if (productIndex !== -1) {
                    products[productIndex].sizes[item.size] -= item.quantity;
                }
            });
            saveData('products', products);

            const newSale = {
                saleId,
                timestamp,
                sellerId,
                customerName,
                customerPhone,
                totalAmount, // Subtotal before discount
                discountAmount,
                finalAmount, // Final amount after discount
                profit: totalProfit, // Store total profit for this sale
                paymentMethod,
                status,
                type: 'sale', // Mark as a sale transaction
                items: currentCart
            };
            sales.push(newSale);
            saveData('sales', sales);

            // If 'due', add to dues list
            if (status === 'বাকি') {
                dues.push({
                    dueId: generateUniqueId('D'),
                    saleId: saleId,
                    customerName: customerName,
                    customerPhone: customerPhone,
                    originalAmount: finalAmount,
                    remainingAmount: finalAmount,
                    paidAmount: 0, // New: Track paid amount
                    dateIssued: timestamp
                });
                saveData('dues', dues);
            }

            alert('বিক্রয় সফলভাবে সম্পন্ন হয়েছে!');
            currentCart = []; // Clear cart
            renderCart(); // Re-render cart
            posPaymentForm.reset();
            discountAmountInput.value = 0;
            customerInfoFields.style.display = 'none';
            printBillBtn.style.display = 'block'; // Show print button after sale
            printBillBtn.dataset.saleId = saleId; // Store sale ID for printing
            renderDashboard(); // Update dashboard summary
        });

        printBillBtn.addEventListener('click', () => {
            const saleIdToPrint = printBillBtn.dataset.saleId;
            if (saleIdToPrint) {
                printBill(saleIdToPrint);
                printBillBtn.style.display = 'none'; // Hide button after printing
            } else {
                alert('প্রিন্ট করার জন্য কোনো বিল নেই।');
            }
        });

        function printBill(saleId) {
            const sale = sales.find(s => s.saleId === saleId && s.type === 'sale');
            if (!sale) {
                alert('বিল খুঁজে পাওয়া যায়নি।');
                return;
            }

            const sellerName = users.find(u => u.id === sale.sellerId)?.displayName || users.find(u => u.id === sale.sellerId)?.username || 'N/A';

            let printContents = `
                <div id="print-area">
                    <h2>${shopSettings.name}</h2>
                    <p>ঠিকানা: ${shopSettings.address}</p>
                    <p>তারিখ: ${new Date(sale.timestamp).toLocaleString()}</p>
                    <p>বিল আইডি: ${sale.saleId}</p>
                    <p>বিক্রয়কারী: ${sellerName}</p>
                    <p>কাস্টমার: ${sale.customerName} ${sale.customerPhone !== 'N/A' ? `(${sale.customerPhone})` : ''}</p>
                    <hr>
                    <table>
                        <thead>
                            <tr>
                                <th>পণ্য</th>
                                <th>সাইজ</th>
                                <th>পরিমাণ</th>
                                <th>মূল্য</th>
                                <th>মোট</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            sale.items.forEach(item => {
                printContents += `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.size}</td>
                        <td>${item.quantity}</td>
                        <td>৳ ${item.unitPrice.toLocaleString()}</td>
                        <td>৳ ${(item.quantity * item.unitPrice).toLocaleString()}</td>
                    </tr>
                `;
            });
            printContents += `
                        </tbody>
                    </table>
                    <hr>
                    <p>মোট: ৳ ${sale.totalAmount.toLocaleString()}</p>
                    <p>ডিসকাউন্ট: ৳ ${sale.discountAmount.toLocaleString()}</p>
                    <p>চূড়ান্ত মূল্য: ৳ ${sale.finalAmount.toLocaleString()}</p>
                    <p>পেমেন্ট ধরণ: ${sale.paymentMethod === 'cash' ? 'নগদ' : sale.paymentMethod === 'card' ? 'কার্ড' : sale.paymentMethod === 'bKash' ? 'বিকাশ' : sale.paymentMethod === 'nagad' ? 'নগদ' : sale.status}</p>
                    <p>ধন্যবাদ!</p>
                </div>
            `;

            const printWindow = window.open('', '_blank', 'height=600,width=800');
            printWindow.document.write('<html><head><title>বিক্রয় বিল</title>');
            printWindow.document.write('<style>');
            printWindow.document.write(`
                body { font-family: 'Noto Sans Bengali', Arial, sans-serif; margin: 0; padding: 20px; box-sizing: border-box; color: black; }
                h2 { text-align: center; margin-bottom: 5px; }
                p { margin: 2px 0; }
                table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                th, td { border: 1px solid black; padding: 5px; text-align: left; font-size: 14px; }
                hr { border: 0; border-top: 1px dashed #ccc; margin: 10px 0; }
            `);
            printWindow.document.write('</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(printContents);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
        }

        // --- Sales Report ---
        function renderSalesReport(filterDate = '', filterSellerId = '') {
            salesReportTableBody.innerHTML = '';
            let filteredTransactions = sales;

            if (filterDate) {
                filteredTransactions = filteredTransactions.filter(transaction => {
                    const transactionDate = new Date(transaction.timestamp).toISOString().split('T')[0];
                    return transactionDate === filterDate;
                });
            }

            if (filterSellerId) {
                filteredTransactions = filteredTransactions.filter(transaction => transaction.sellerId === filterSellerId);
            }

            // If seller is logged in, show only their sales/returns
            if (currentUser.role === 'seller') {
                filteredTransactions = filteredTransactions.filter(transaction => transaction.sellerId === currentUser.id);
            }

            // Calculate net sales and net profit considering returns
            let netFilteredSalesTotal = 0;
            let netFilteredProfit = 0;

            filteredTransactions.forEach(transaction => {
                if (transaction.type === 'sale') {
                    netFilteredSalesTotal += transaction.finalAmount;
                    netFilteredProfit += transaction.profit || 0;
                } else if (transaction.type === 'return') {
                    netFilteredSalesTotal += transaction.finalAmount; // This is already negative
                    netFilteredProfit += transaction.profit || 0; // This should also be negative for returns
                }
            });

            filteredSalesTotalSpan.textContent = `৳ ${netFilteredSalesTotal.toLocaleString()}`;
            filteredSalesProfitSpan.textContent = `মোট লাভ: ৳ ${netFilteredProfit.toLocaleString()}`;
            if (currentUser.role !== 'admin') { // Sellers don't see profit
                 filteredSalesProfitSpan.style.display = 'none';
            } else {
                 filteredSalesProfitSpan.style.display = 'block';
            }


            if (filteredTransactions.length === 0) {
                const row = salesReportTableBody.insertRow();
                const cell = row.insertCell(0);
                cell.colSpan = 9;
                cell.textContent = 'কোনো লেনদেন খুঁজে পাওয়া যায়নি।';
                return;
            }

            filteredTransactions.forEach(transaction => {
                const row = salesReportTableBody.insertRow();
                const isReturn = transaction.type === 'return';
                if (isReturn) {
                    row.classList.add('return-row');
                }

                row.insertCell(0).textContent = transaction.saleId;
                row.insertCell(1).textContent = new Date(transaction.timestamp).toLocaleString();
                row.insertCell(2).textContent = users.find(u => u.id === transaction.sellerId)?.displayName || users.find(u => u.id === transaction.sellerId)?.username || 'N/A';
                row.insertCell(3).textContent = transaction.customerName;
                row.insertCell(4).textContent = `৳ ${transaction.finalAmount.toLocaleString()}`;
                const profitCell = row.insertCell(5);
                if (currentUser.role === 'admin') {
                    profitCell.textContent = `৳ ${(transaction.profit || 0).toLocaleString()}`;
                    profitCell.style.color = (transaction.profit || 0) < 0 ? '#dc3545' : '#28a745'; // Red for loss, green for profit
                } else {
                    profitCell.textContent = '***'; // Hide profit from sellers
                }


                row.insertCell(6).textContent = isReturn ? 'ফেরত' : (transaction.paymentMethod === 'cash' ? 'নগদ' : transaction.paymentMethod === 'card' ? 'কার্ড' : transaction.paymentMethod === 'bKash' ? 'বিকাশ' : transaction.paymentMethod === 'nagad' ? 'নগদ' : transaction.status);
                row.insertCell(7).textContent = isReturn ? 'ফেরত' : transaction.status;

                const itemsCell = row.insertCell(8);
                const itemsList = document.createElement('ul');
                itemsList.style.listStyle = 'none';
                itemsList.style.padding = '0';
                transaction.items.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = `${item.name} (${item.size}) x ${item.quantity} @ ৳ ${item.unitPrice.toLocaleString()}`;
                    itemsList.appendChild(li);
                });
                itemsCell.appendChild(itemsList);
            });
        }

        function populateSellerFilter() {
            salesReportSellerSelect.innerHTML = '<option value="">সকল সেলার</option>';
            const sellers = users.filter(u => u.role === 'seller' || u.role === 'admin'); // Include admins in seller list
            sellers.forEach(seller => {
                const option = document.createElement('option');
                option.value = seller.id;
                option.textContent = seller.displayName || seller.username;
                salesReportSellerSelect.appendChild(option);
            });

            if (currentUser.role === 'seller') {
                salesReportSellerSelect.value = currentUser.id;
                salesReportSellerSelect.disabled = true; // Seller can only see their own sales
            } else {
                salesReportSellerSelect.disabled = false;
            }
        }

        filterSalesReportBtn.addEventListener('click', () => {
            const date = salesReportDateInput.value;
            const sellerId = salesReportSellerSelect.value;
            renderSalesReport(date, sellerId);
        });

        // --- Dues Management ---
        function renderDuesList() {
            duesListTableBody.innerHTML = '';
            const totalDues = dues.reduce((sum, due) => sum + due.remainingAmount, 0);
            totalDuesAmountSpan.textContent = `৳ ${totalDues.toLocaleString()}`;

            if (dues.length === 0) {
                const row = duesListTableBody.insertRow();
                const cell = row.insertCell(0);
                cell.colSpan = 7;
                cell.textContent = 'কোনো বাকি টাকা নেই।';
                return;
            }

            dues.forEach(due => {
                const row = duesListTableBody.insertRow();
                row.insertCell(0).textContent = due.customerName;
                row.insertCell(1).textContent = due.customerPhone;
                row.insertCell(2).textContent = due.saleId;
                row.insertCell(3).textContent = `৳ ${due.remainingAmount.toLocaleString()}`;
                row.insertCell(4).textContent = `৳ ${due.originalAmount.toLocaleString()}`; // Original amount
                row.insertCell(5).textContent = `৳ ${due.paidAmount.toLocaleString()}`; // Paid amount

                const actionCell = row.insertCell(6);
                const payBtn = document.createElement('button');
                payBtn.textContent = 'পরিশোধ করুন';
                payBtn.className = 'btn primary-btn';
                payBtn.addEventListener('click', () => promptForDuePayment(due.dueId, due.remainingAmount));
                actionCell.appendChild(payBtn);
            });
        }

        function promptForDuePayment(dueId, currentRemaining) {
            const amountStr = prompt(`কত টাকা পরিশোধ করা হয়েছে? (সর্বোচ্চ ${currentRemaining.toLocaleString()} ৳)`);
            if (amountStr === null) return; // User cancelled

            const paidAmount = parseFloat(amountStr);

            if (isNaN(paidAmount) || paidAmount <= 0) {
                alert('বৈধ পরিমাণ প্রবেশ করান।');
                return;
            }
            if (paidAmount > currentRemaining) {
                alert(`পরিশোধের পরিমাণ বকেয়া পরিমাণের চেয়ে বেশি হতে পারে না।`);
                return;
            }

            const dueIndex = dues.findIndex(d => d.dueId === dueId);
            if (dueIndex !== -1) {
                dues[dueIndex].remainingAmount -= paidAmount;
                dues[dueIndex].paidAmount += paidAmount; // Update paid amount

                if (dues[dueIndex].remainingAmount <= 0.01) { // Floating point comparison
                    dues.splice(dueIndex, 1); // Remove if fully paid
                    alert(`বাকি টাকা সফলভাবে পরিশোধ করা হয়েছে!`);
                } else {
                    alert(`৳ ${paidAmount.toLocaleString()} সফলভাবে পরিশোধ করা হয়েছে। বাকি: ৳ ${dues[dueIndex].remainingAmount.toLocaleString()}`);
                }
                saveData('dues', dues);
                renderDuesList();
                renderDashboard(); // Update dashboard due summary
            }
        }

        // --- Returns Management ---
        searchSaleForReturnBtn.addEventListener('click', () => {
            const searchTerm = returnSaleIdInput.value.trim();
            // Find only 'sale' type transactions for return
            const sale = sales.find(s => s.saleId === searchTerm && s.type === 'sale');

            if (!sale) {
                alert('এই আইডি দিয়ে কোনো বিক্রয় খুঁজে পাওয়া যায়নি।');
                returnDetailsContainer.style.display = 'none';
                return;
            }

            returnDetailsContainer.style.display = 'block';
            returnSaleIdDisplay.textContent = sale.saleId;
            returnSaleTotalDisplay.textContent = `৳ ${sale.finalAmount.toLocaleString()}`;

            returnItemsTableBody.innerHTML = '';

            if (sale.items && sale.items.length > 0) {
                sale.items.forEach(item => {
                    const row = returnItemsTableBody.insertRow();
                    row.insertCell(0).textContent = item.name;
                    row.insertCell(1).textContent = item.size;
                    row.insertCell(2).textContent = item.quantity;
                    row.insertCell(3).textContent = `৳ ${item.unitPrice.toLocaleString()}`;

                    const returnQuantityCell = row.insertCell(4);
                    const returnInput = document.createElement('input');
                    returnInput.type = 'number';
                    returnInput.value = 0;
                    returnInput.min = 0;
                    returnInput.max = item.quantity;
                    returnInput.style.width = '50px';
                    returnInput.dataset.productId = item.productId;
                    returnInput.dataset.size = item.size;
                    returnInput.dataset.unitPrice = item.unitPrice;
                    returnInput.dataset.purchasePrice = item.purchasePrice || 0; // Capture purchase price for return profit calculation
                    returnInput.dataset.originalQuantity = item.quantity; // Store original quantity
                    returnInput.addEventListener('input', updateRefundableAmount);
                    returnQuantityCell.appendChild(returnInput);
                });
            } else {
                 const row = returnItemsTableBody.insertRow();
                 const cell = row.insertCell(0);
                 cell.colSpan = 5;
                 cell.textContent = 'এই বিক্রয়ে কোনো পণ্য নেই বা তথ্য অসম্পূর্ণ।';
            }
            updateRefundableAmount();
        });

        function updateRefundableAmount() {
            let total = 0;
            document.querySelectorAll('#return-items-table input[type="number"]').forEach(input => {
                const quantity = parseInt(input.value) || 0;
                const unitPrice = parseFloat(input.dataset.unitPrice);
                total += (quantity * unitPrice);
            });
            refundableAmountSpan.textContent = `৳ ${total.toLocaleString()}`;
        }

        processReturnBtn.addEventListener('click', () => {
            const saleId = returnSaleIdDisplay.textContent;
            const originalSale = sales.find(s => s.saleId === saleId && s.type === 'sale');
            if (!originalSale) {
                alert('রিটার্নের জন্য মূল বিক্রয় খুঁজে পাওয়া যায়নি।');
                return;
            }

            const returnedItems = [];
            let returnedProfit = 0; // Profit deduction for returns
            document.querySelectorAll('#return-items-table input[type="number"]').forEach(input => {
                const quantity = parseInt(input.value) || 0;
                if (quantity > 0) {
                    const productId = input.dataset.productId;
                    const productName = products.find(p => p.id === productId)?.name || 'Unknown Product';
                    const size = input.dataset.size;
                    const unitPrice = parseFloat(input.dataset.unitPrice);
                    const purchasePrice = parseFloat(input.dataset.purchasePrice);

                    returnedItems.push({
                        productId: productId,
                        name: productName,
                        size: size,
                        quantity: quantity,
                        unitPrice: unitPrice,
                        purchasePrice: purchasePrice
                    });
                    returnedProfit += (unitPrice - purchasePrice) * quantity;
                }
            });

            if (returnedItems.length === 0) {
                alert('ফেরত দেওয়ার জন্য কোনো পণ্য নির্বাচন করা হয়নি।');
                return;
            }

            const refundableAmount = parseFloat(refundableAmountSpan.textContent.replace('৳ ', '').replace(/,/g, ''));
            if (!confirm(`আপনি কি এই ${returnedItems.length} টি পণ্য ফেরত নিতে এবং ৳ ${refundableAmount.toLocaleString()} টাকা ফেরত দিতে নিশ্চিত?`)) {
                return;
            }

            // Update product stock for returned items
            returnedItems.forEach(returnedItem => {
                const product = products.find(p => p.id === returnedItem.productId);
                if (product) {
                    product.sizes[returnedItem.size] = (product.sizes[returnedItem.size] || 0) + returnedItem.quantity;
                }
            });
            saveData('products', products);

            // Create a new 'return' transaction
            const returnTransaction = {
                saleId: generateUniqueId('R'), // Unique ID for return transaction
                originalSaleId: saleId, // Link to the original sale
                timestamp: new Date().toISOString(),
                sellerId: currentUser.id, // The seller who processed the return
                customerName: originalSale.customerName,
                customerPhone: originalSale.customerPhone,
                totalAmount: -refundableAmount, // Negative amount for deduction
                discountAmount: 0,
                finalAmount: -refundableAmount, // Final amount for deduction (negative)
                profit: -returnedProfit, // Negative profit for deduction
                paymentMethod: 'cash_refund', // Indicating cash refund
                status: 'ফেরত সম্পন্ন',
                type: 'return', // Mark as a return transaction
                items: returnedItems
            };
            sales.push(returnTransaction);
            saveData('sales', sales);

            alert(`পণ্য সফলভাবে ফেরত নেওয়া হয়েছে এবং ৳ ${refundableAmount.toLocaleString()} টাকা ফেরত দেওয়া হয়েছে।`);
            returnDetailsContainer.style.display = 'none';
            returnSaleIdInput.value = '';
            renderSalesReport(); // Re-render sales report to reflect changes
            renderDashboard(); // Re-render dashboard for updated summary
        });


        // --- Ledger Management (New Feature) ---
        function renderLedger(filterDate = '', filterType = '') {
            ledgerTableBody.innerHTML = '';
            let filteredLedger = ledgerEntries;

            if (filterDate) {
                filteredLedger = filteredLedger.filter(entry => {
                    const entryDate = new Date(entry.timestamp).toISOString().split('T')[0];
                    return entryDate === filterDate;
                });
            }
            if (filterType) {
                filteredLedger = filteredLedger.filter(entry => entry.type === filterType);
            }

            let totalIncome = 0;
            let totalExpenses = 0;

            if (filteredLedger.length === 0) {
                const row = ledgerTableBody.insertRow();
                const cell = row.insertCell(0);
                cell.colSpan = 5;
                cell.textContent = 'কোনো লেনদেন খুঁজে পাওয়া যায়নি।';
            } else {
                filteredLedger.forEach(entry => {
                    const row = ledgerTableBody.insertRow();
                    row.insertCell(0).textContent = new Date(entry.timestamp).toLocaleDateString();
                    row.insertCell(1).textContent = entry.type === 'expense' ? 'খরচ' : 'আয়';
                    row.insertCell(2).textContent = entry.description;
                    const amountCell = row.insertCell(3);
                    amountCell.textContent = `৳ ${entry.amount.toLocaleString()}`;
                    amountCell.style.color = entry.type === 'expense' ? '#dc3545' : '#28a745';

                    if (entry.type === 'expense') {
                        totalExpenses += entry.amount;
                    } else {
                        totalIncome += entry.amount;
                    }

                    const actionCell = row.insertCell(4);
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'মুছুন';
                    deleteBtn.className = 'danger-btn';
                    deleteBtn.addEventListener('click', () => deleteLedgerEntry(entry.id));
                    actionCell.appendChild(deleteBtn);
                });
            }

            totalOtherIncomeSpan.textContent = `৳ ${totalIncome.toLocaleString()}`;
            totalExpensesSpan.textContent = `৳ ${totalExpenses.toLocaleString()}`;
            netLedgerBalanceSpan.textContent = `৳ ${(totalIncome - totalExpenses).toLocaleString()}`;
            netLedgerBalanceSpan.style.color = (totalIncome - totalExpenses) < 0 ? '#dc3545' : '#28a745';

            if (currentUser.role !== 'admin') { // Only admin can see and manage ledger
                 addLedgerEntryForm.style.display = 'none';
                 ledgerSection.querySelectorAll('.action-buttons, .danger-btn').forEach(btn => btn.style.display = 'none');
            } else {
                addLedgerEntryForm.style.display = 'block';
            }
        }

        addLedgerEntryForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const type = ledgerTypeSelect.value;
            const description = ledgerDescriptionInput.value.trim();
            const amount = parseFloat(ledgerAmountInput.value);
            const date = ledgerDateInput.value;

            if (isNaN(amount) || amount <= 0) {
                alert('বৈধ পরিমাণ প্রবেশ করান।');
                return;
            }
            if (!date) {
                alert('অনুগ্রহ করে একটি তারিখ নির্বাচন করুন।');
                return;
            }

            const newEntry = {
                id: generateUniqueId('L'),
                timestamp: new Date(date).toISOString(),
                type: type,
                description: description,
                amount: amount
            };
            ledgerEntries.push(newEntry);
            saveData('ledgerEntries', ledgerEntries);
            alert('লেনদেন সফলভাবে যোগ করা হয়েছে!');
            addLedgerEntryForm.reset();
            const today = new Date().toISOString().split('T')[0];
            ledgerDateInput.value = today; // Reset date input to today
            renderLedger();
        });

        document.getElementById('cancel-ledger-entry').addEventListener('click', () => {
            addLedgerEntryForm.reset();
             const today = new Date().toISOString().split('T')[0];
            ledgerDateInput.value = today;
        });

        filterLedgerBtn.addEventListener('click', () => {
            const date = ledgerFilterDateInput.value;
            const type = ledgerFilterTypeSelect.value;
            renderLedger(date, type);
        });

        function deleteLedgerEntry(id) {
            if (currentUser.role !== 'admin') {
                alert('আপনার এই লেনদেন মুছে ফেলার অনুমতি নেই।');
                return;
            }
            if (confirm('আপনি কি নিশ্চিত এই লেনদেনটি মুছে ফেলতে চান?')) {
                ledgerEntries = ledgerEntries.filter(entry => entry.id !== id);
                saveData('ledgerEntries', ledgerEntries);
                alert('লেনদেন সফলভাবে মুছে ফেলা হয়েছে!');
                renderLedger();
            }
        }

        // --- User Management (Admin Only) ---
        function renderUserList() {
            if (currentUser.role !== 'admin') {
                userListTableBody.innerHTML = '<tr><td colspan="5">আপনার ব্যবহারকারী দেখার অনুমতি নেই।</td></tr>';
                return;
            }

            userListTableBody.innerHTML = '';
            users.forEach(user => {
                const row = userListTableBody.insertRow();
                row.insertCell(0).textContent = user.id;
                row.insertCell(1).textContent = user.username;
                row.insertCell(2).textContent = user.displayName || 'N/A'; // Display actual name
                row.insertCell(3).textContent = user.role === 'admin' ? 'অ্যাডমিন' : 'সেলার';
                const actionCell = row.insertCell(4);
                actionCell.className = 'table-action-buttons';

                if (user.id !== currentUser.id) { // Cannot edit/delete self
                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'সম্পাদনা';
                    editBtn.className = 'edit-btn';
                    editBtn.addEventListener('click', () => editUser(user.id));
                    actionCell.appendChild(editBtn);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'মুছুন';
                    deleteBtn.className = 'danger-btn';
                    deleteBtn.addEventListener('click', () => deleteUser(user.id));
                    actionCell.appendChild(deleteBtn);
                } else {
                    actionCell.textContent = 'নিজস্ব অ্যাকাউন্ট';
                }
            });
        }

        addUserBtn.addEventListener('click', () => {
            if (currentUser.role === 'admin') {
                addUserFormContainer.style.display = 'block';
                addUserForm.reset();
                addUserForm.dataset.editingId = '';
                newUserDisplayNameInput.value = '';
                newUserProfileImageInput.value = '';
            } else {
                alert('আপনার নতুন ব্যবহারকারী যোগ করার অনুমতি নেই।');
            }
        });

        document.querySelectorAll('#add-user-form-container .cancel-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                addUserFormContainer.style.display = 'none';
                addUserForm.reset();
            });
        });

        addUserForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const id = addUserForm.dataset.editingId || generateUniqueId('U');
            const username = document.getElementById('new-username').value;
            const password = document.getElementById('new-password').value;
            const role = document.getElementById('new-user-role').value;
            const displayName = newUserDisplayNameInput.value.trim(); // New
            const profileImage = newUserProfileImageInput.value.trim(); // New

            if (addUserForm.dataset.editingId) {
                const index = users.findIndex(u => u.id === id);
                if (index !== -1) {
                    users[index] = { ...users[index], username, password, role, displayName, profileImage };
                    alert('ব্যবহারকারী সফলভাবে আপডেট করা হয়েছে!');
                    if (id === currentUser.id) { // If current user updated their own profile
                        currentUser = users[index]; // Update currentUser object
                        updateUserProfileDisplay();
                    }
                }
            } else {
                if (users.some(u => u.username === username)) {
                    alert('এই ইউজারনেমটি আগে থেকেই বিদ্যমান।');
                    return;
                }
                users.push({ id, username, password, role, displayName, profileImage });
                alert('ব্যবহারকারী সফলভাবে যোগ করা হয়েছে!');
            }
            saveData('users', users);
            renderUserList();
            addUserFormContainer.style.display = 'none';
            addUserForm.reset();
        });

        function editUser(id) {
            if (currentUser.role !== 'admin') return;

            const user = users.find(u => u.id === id);
            if (user) {
                addUserFormContainer.style.display = 'block';
                document.getElementById('new-username').value = user.username;
                document.getElementById('new-password').value = user.password;
                document.getElementById('new-user-role').value = user.role;
                newUserDisplayNameInput.value = user.displayName || '';
                newUserProfileImageInput.value = user.profileImage || '';
                addUserForm.dataset.editingId = user.id;
            }
        }

        function deleteUser(id) {
            if (currentUser.role !== 'admin') return;

            if (id === currentUser.id) {
                alert('আপনি নিজের অ্যাকাউন্ট মুছে ফেলতে পারবেন না।');
                return;
            }

            if (confirm('আপনি কি নিশ্চিত এই ব্যবহারকারীকে মুছে ফেলতে চান?')) {
                users = users.filter(u => u.id !== id);
                saveData('users', users);
                renderUserList();
                alert('ব্যবহারকারী সফলভাবে মুছে ফেলা হয়েছে!');
            }
        }


        // --- Settings ---
        shopInfoForm.addEventListener('submit', (event) => {
            event.preventDefault();
            shopSettings.name = document.getElementById('shop-name').value;
            shopSettings.address = document.getElementById('shop-address').value;
            saveData('shopSettings', shopSettings);
            updateShopTitle(shopSettings.name);
            alert('দোকানের তথ্য সফলভাবে আপডেট করা হয়েছে!');
        });

        resetAllDataBtn.addEventListener('click', () => {
            if (currentUser.role !== 'admin') {
                alert('আপনার সকল ডেটা রিসেট করার অনুমতি নেই।');
                return;
            }
            if (confirm('আপনি কি নিশ্চিত? সফটওয়্যারের সকল ডেটা (পণ্য, বিক্রয়, ব্যবহারকারী, বাকি টাকা) স্থায়ীভাবে মুছে যাবে। এই কাজটি অপরিবর্তনীয়!')) {
                if (confirm('আপনি কি সত্যিই নিশ্চিত? এটি আপনার সকল ডেটা মুছে দেবে।')) {
                    localStorage.clear();
                    initializeData();
                    handleLogout();
                    alert('সফটওয়্যারের সকল ডেটা সফলভাবে রিসেট করা হয়েছে।');
                }
            }
        });


        // --- Event Listeners ---
        loginForm.addEventListener('submit', handleLogin);
        logoutBtn.addEventListener('click', handleLogout);

        mainNavUl.addEventListener('click', (event) => {
            if (event.target.tagName === 'A') {
                event.preventDefault();
                const section = event.target.dataset.section;
                showSection(section);
            }
        });

        userAvatarDisplay.addEventListener('click', () => {
            // Option to navigate to settings or user profile section
            showSection('users'); // Or a specific profile edit section if you create one
            if (currentUser) {
                editUser(currentUser.id); // Open edit form for current user
            }
        });


        document.addEventListener('DOMContentLoaded', () => {
            initializeData();
            loginContainer.style.display = 'block';
            appContainer.style.display = 'none';

            // Check if moment.js is loaded (should be via CDN)
            if (typeof moment === 'undefined') {
                console.warn("Moment.js is not loaded. Please ensure the CDN link is correct for time calculations.");
                // Fallback for timeAgo if moment.js isn't available
                // (You might need a simpler custom function here)
            }

            // Set today's date for relevant inputs
            const today = new Date().toISOString().split('T')[0];
            salesReportDateInput.value = today;
            ledgerDateInput.value = today; // For adding new ledger entry
        });

    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/locale/bn.min.js"></script> <script>
        // Set Bengali locale for moment.js
        if (typeof moment !== 'undefined') {
            moment.locale('bn');
        }
    </script>
</body>
</html>